var utils = require('../utils')
  , req = require('request')
  , qs = require('querystring');

/**
 * Add Twitter authentication. Visit `/twitter` to start
 * the process.
 *
 * Config:
 *     `host` the full URL to your app, e.g. 'http://myapp.com'
 *     `twitter` object containing { key, secret }
 *
 * Callback:
 *     `err` the auth error, or null on no error
 *     `user` an object containing user data and the oauth tokens
 *     `request` the HTTP request object
 *     `response` the HTTP response object
 *     `next`
 *
 * @param {HTTPServer} server
 * @param {object} config
 * @param {function} callbackFn
 * @api public
 */

module.exports = function (server, config, callbackFn) {

    var host = config.host.replace(/\/$/, '')
      , callback_path = '/twitter' + utils.randStr(4);

    var oauth = {
        callback: host + callback_path
      , consumer_key: config.twitter.key
      , consumer_secret: config.twitter.secret
    };

    server.get('/twitter', function (request, response) {
        var url = 'https://api.twitter.com/oauth/request_token';
        req.post({ url: url, oauth: oauth }, function (err, res, body) {
            if (!request.session && !err) err = 'session';
            if (err) return callbackFn(err, null, request, response, next);
            request.session.twitter = qs.parse(body);
            url = 'https://api.twitter.com/oauth/authorize'
                + '?oauth_token=' + request.session.twitter.oauth_token;
            response.redirect(url);
        });
    });

    server.get(callback_path, function (request, response, next) {
        function callback(err, body) {
            callbackFn(err, body || null, request, response, next);
        }

        if (!request.session || !request.session.twitter) {
            return callback('session');
        }

        var url = 'https://api.twitter.com/oauth/access_token'
          , oauth = {
            consumer_key: config.twitter.key
          , consumer_secret: config.twitter.secret
          , token: request.session.twitter.oauth_token
          , token_secret: request.session.twitter.oauth_token_secret
          , verifier: request.param('oauth_verifier')
        };

        req.post({ url: url, oauth: oauth }, function (err, res, body) {
            if (err) return callback(err);

            var perms = qs.parse(body)
              , oauth = {
                consumer_key: config.twitter.key
              , consumer_secret: config.twitter.secret
              , token: perms.oauth_token
              , token_secret: perms.oauth_token_secret
            };

            var url = 'https://api.twitter.com/1/users/show.json'
                    + '?screen_name=' + perms.screen_name
                    + '&user_id=' + perms.user_id;

            req.get({ url: url, oauth: oauth, json: true }, function (err, res, user) {
                user.oauth = perms;
                callback(err, user);
            });
        });
    });

};

