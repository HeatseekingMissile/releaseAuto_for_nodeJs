var utils = require('../utils')
  , req = require('request')
  , qs = require('querystring');

/**
 * Dropbox API calls.
 */

var base_url = 'https://api.dropbox.com/1/'
  , request_url = base_url + 'oauth/request_token'
  , authorise_url = base_url + 'oauth/authorize'
  , access_url = base_url + 'oauth/access_token'
  , account_url = base_url + 'account/info';

/**
 * Add Dropbox authentication. Visit `/dropbox` to start
 * the process.
 *
 * Config:
 *     `host` the full URL to your app, e.g. 'http://myapp.com'
 *     `dropbox` object containing { key, secret }
 *
 * Callback:
 *     `err` the auth error, or null on no error
 *     `user` an object containing user data and the oauth tokens
 *     `request` the HTTP request object
 *     `response` the HTTP response object
 *     `next`
 *
 * @param {HTTPServer} server
 * @param {object} config
 * @param {function} callbackFn
 * @api public
 */

module.exports = function (server, config, callbackFn) {

    var host = config.host.replace(/\/$/, '')
      , callback_path = '/dropbox/' + utils.randStr(4);

    var oauth = {
        callback: host + callback_path
      , consumer_key: config.dropbox.key
      , consumer_secret: config.dropbox.secret
    };

    server.get('/dropbox', function (request, response) {
        req.post({ url: request_url, oauth: oauth }, function (err, res, body) {
            if (!request.session && !err) err = 'session';
            if (err) return callbackFn(err, null, request, response, next);
            request.session.dropbox = qs.parse(body);
            url = authorise_url
                + '?oauth_token=' + request.session.dropbox.oauth_token
                + '&oauth_callback=' + oauth.callback;
            response.redirect(url);
        });
    });

    server.get(callback_path, function (request, response, next) {
        function callback(err, body) {
            callbackFn(err, body || null, request, response, next);
        }

        if (!request.session || !request.session.dropbox) {
            return callback('session');
        }

        if (request.param('uid')) {
            request.session.dropbox.uid = request.param('uid');
        }

        var oauth = {
            consumer_key: config.dropbox.key
          , consumer_secret: config.dropbox.secret
          , token: request.session.dropbox.oauth_token
          , token_secret: request.session.dropbox.oauth_token_secret
          , verifier: request.param('oauth_verifier')
        };

        req.post({ url: access_url, oauth: oauth }, function (err, res, body) {
            if (err) return callback(err);

            var perms = parse(body)
              , oauth = {
                consumer_key: config.dropbox.key
              , consumer_secret: config.dropbox.secret
              , token: perms.oauth_token
              , token_secret: perms.oauth_token_secret
            };

            req.get({ url: account_url, oauth: oauth, json: true }, function (err, res, user) {
                if (err || !user || user.error) return callback(err || user.error || 'error');
                user.oauth = oauth;
                callback(null, user);
            });
        });
    });

};

