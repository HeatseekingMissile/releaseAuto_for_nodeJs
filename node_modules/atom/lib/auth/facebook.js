var utils = require('../utils')
  , req = require('request')
  , qs = require('querystring');

/**
 * Facebook API calls.
 */

var authorise_url = 'https://www.facebook.com/dialog/oauth'
  , access_url = 'https://graph.facebook.com/oauth/access_token'
  , account_url = 'https://graph.facebook.com/me';

/**
 * Add Facebook authentication. Visit `/facebook` to start
 * the process.
 *
 * Config:
 *     `host` the full URL to your app, e.g. 'http://myapp.com'
 *     `facebook` object containing { key, secret, scope || '' }
 *
 * Callback:
 *     `err` the auth error, or null on no error
 *     `user` an object containing user data and the access token
 *     `request` the HTTP request object
 *     `response` the HTTP response object
 *     `next`
 *
 * @param {HTTPServer} server
 * @param {object} config
 * @param {function} callbackFn
 * @api public
 */

module.exports = function (server, config, callbackFn) {

    var host = config.host.replace(/\/$/, '')
      , callback_path = '/facebook/' + utils.randStr(4);

    server.get('/facebook', function (request, response) {
        var url = authorise_url
                + '?client_id=' + config.facebook.key
                + '&redirect_uri=' + host + callback_path
                + '&scope=' + (config.facebook.scope || '');
        response.redirect(url);
    });

    server.get(callback_path, function (request, response, next) {
        function callback(err, body) {
            callbackFn(err, body || null, request, response, next);
        }

        if (request.param('error')) {
            return callback(request.param('error_reason'));
        }

        var url = access_url
                + '?client_id=' + config.facebook.key
                + '&redirect_uri=' + host + callback_path
                + '&client_secret=' + config.facebook.secret
                + '&code=' + request.param('code');

        req(url, function (err, res, body) {
            if (err || !~body.indexOf('access_token')) {
                return callback('verification failed');
            }

            var access = qs.parse(body)
              , url = account_url + '?access_token=' + access.access_token;

            req(url, function (err, res, body) {
                try {
                    if (err) throw err;
                    body = JSON.parse(body);
                    body.access_token = access.access_token;
                    body.expires = access.expires || false;
                    callback(null, body);
                } catch (e) {
                    callback('get profile failed');
                }
            });
        });
    });

};

