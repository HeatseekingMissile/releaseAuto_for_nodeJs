var fs = require('fs');

module.exports = function (dir, options) {

    var dirfiles, files = {};

    options = options || {};
    options.args = options.args || [];
    options.pre = options.pre || [];
    options.post = options.post || [];
    dir = dir.replace(/\/$/, '');

    //Check if the dir exists
    try {
        dirfiles = fs.readdirSync(dir);
    } catch (e) {
        if (options.ignore) return;
        throw e;
    };

    //Load all files in the directory
    dirfiles.forEach(function (file) {
        if (!/\.js$/.test(file)) return;
        var module = require(dir + '/' + file)
          , name = file.replace('.js', '');
        if (typeof module !== "function") {
            throw new Error('%s: expecting a function module.exports');
        }
        files[name] = module;
    });

    //Check for array args
    if (!Array.isArray(options.args)) {
        options.args = [options.args];
    }

    //Helper for Loading modules
    function load(module) {
        if (typeof files[module] === 'undefined') return;
        files[module].apply(options.scope || {}, options.args);
        delete files[module];
    }

    //Load pre routes
    options.pre.forEach(load);

    //Load other routes
    for (var module in files) {
        if (!~options.post.indexOf(module)) {
            load(module);
        }
    }

    //Load post routes
    options.post.forEach(load);

};

