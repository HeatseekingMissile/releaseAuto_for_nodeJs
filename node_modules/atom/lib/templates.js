var fs = require('fs')
  , cache = {};

function load(template) {
    if (typeof cache[template] !== 'undefined') {
        return cache[template];
    }
    return cache[template] = fs.readFileSync(template).toString();
}

function escape(str) {
    return str.replace(new RegExp('[.*+?|()\\[\\]{}]', 'g'), '\\$&');
}

module.exports = function (options) {
    var ext = options.ext || ''
      , dir = options.dir || ''
      , open = options.open || '{{'
      , close = options.close || '}}';

    if (ext) {
        ext = '.' + ext.replace(/^\./, '')
    }
    if (dir) {
        dir = dir.replace(/\/$/, '') + '/';
    }

    open = escape(open);
    close = escape(close);

    return function (template, vars) {
        template = dir + template + ext;
        vars = vars || {};
        var key, replace, template = load(template);
        for (key in vars) {
            replace = new RegExp(open + key + close);
            template = template.replace(replace, vars[key]);
        }
        return template;
    };
};

